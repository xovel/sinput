/*!
 * sinput 1.0.2
 * Copyright 2017 xovel, MIT licensed
 * https://github.com/xovel/sinput
 */
if("undefined"==typeof jQuery)throw new Error("Sinput's JavaScript requires jQuery");+function(e){"use strict";e.fn.sinput=function(t){if("object"!=typeof t)throw new Error("Need options");if(!t.data&&!t.ajax)throw new Error("Need data");t=e.extend({kls:"sinput",unique:!1,name:"",placeholder:"",maxLength:0,height:200,fontSize:"12px",border:"1px solid #66afe9",padding:"5px",zIndex:0,hoverColor:"#fff",hoverBackground:"#999",title:!0,ellipsis:!1,extraData:[],extraDataName:!1,idPrefix:"sinput-",preventKeyEvent:!1,data:[],text:"text",highlight:!1,add:!1,callback:null,onHide:!1,onInput:!1,forceTrigger:!1,ajax:!1,responseReader:"data",headers:{},init:!0,cache:!1,url:"",urlParse:!1,type:"get",dataType:"json",stringify:!0,searchName:"q",searchParam:{},searchForce:!1,searchUrl:"",searchHeaders:{},searchType:"",searchDataType:""},e.fn.sinput._default,t);var a={tab:9,enter:13,esc:27,left:37,up:38,right:39,down:40};return t.extraDataName===!0&&(t.extraDataName=t.extraData),this.each(function(){function r(a,r){var o=t.type,i=t.url,s=t.dataType,c=t.headers,l=t.searchParam;if(a&&(i=t.searchUrl||i,o=t.searchType||o,s=t.searchDataType||s,c=e.extend({},c,t.searchHeaders)),t.urlParse){var h,p,f;if(h=i.split("?"),i=h[0],h[1]){p=h[1].split("&");for(var g=0;g<p.length;g++)f=p[g].split("="),l[f[0]]=f[1]}}l[t.searchName]=a||"","post"===o.toLowerCase()&&(t.stringify&&"object"==typeof JSON&&JSON.stringify&&(l=JSON.stringify(l)),"json"===s.toLowerCase()&&(c=e.extend({},c,{Accept:"application/json","Content-Type":"application/json"}))),e.ajax({headers:c,url:i,type:o,data:l,datatype:s,beforeSend:function(){b=!1,v.html("正在加载数据...").show().siblings().remove()},success:function(o){var i,s="";return i=t.responseReader?n(o,t.responseReader):o,"array"!==e.type(i)?(v.html("数据类型错误，请检查相关配置").show(),!1):void(i.length<1?(s=a?t.add?"没有该数据，可添加":"没有该数据":"暂无数据",v.html(s).show()):(w=d(i),u(w,t.searchForce?a:""),e.isFunction(r)&&r.call()))},error:function(){b=!0,v.html("网络异常，请稍后再试").show()}})}function n(e,t){for(var a,r=t.split("."),n=e,o=0;o<r.length;o++)a=n[r[o]],n=a;return a}function o(a){if(f.hide(),a&&!t.add){var r,n=p.val();e.each(k,function(e,a){if(n===a[t.text])return r=a,!1}),r||(n="",p.val("")),t.onHide&&e.isFunction(t.callback)&&t.callback.call(null,n,r)}}function i(a,r,n){var o;if(e.each(k,function(e,r){if(a===r[t.text])return o=r,!1}),o)e.each(t.extraData,function(a,r){var n=o[r];if(t.extraDataName){var i=t.extraDataName[a];e("#"+t.idPrefix+i).remove(),e("<input>").attr({id:t.idPrefix+i,name:i,type:"hidden"}).val(n).insertAfter(p)}else p.removeAttr("data-"+r),p.attr("data-"+r,n)});else if(!n)return;if(r){var i=e.isFunction(r)?r:e.isFunction(t.callback)?t.callback:e.noop;i.call(null,a,o)}}function s(){e.each(t.extraData,function(a,r){if(t.extraDataName){var n=t.extraDataName[a];e("#"+t.idPrefix+n).remove()}else p.removeAttr("data-"+r)})}function c(e){var a,r=f.find(".hover");a=e?r.prev(".sinput-item"):r.next(".sinput-item"),0!==a.length&&(a.addClass("hover").css({color:t.hoverColor,background:t.hoverBackground}),r.removeClass("hover").css({color:"",background:""}),l(a,e))}function l(e,t){var a=f.scrollTop();if(t){var r=e.offset().top-f.offset().top+a;a>r&&(C=!0,f.scrollTop(r))}else{var n=f.height(),o=e.offset().top-f.offset().top+e.outerHeight();n<o&&(C=!0,f.scrollTop(a+o-n))}}function d(a){var r=[],n={};return e.each(a,function(e,a){"string"==typeof a?n[t.text]=a:(n=a,n[t.text]=n[t.text]||""),r.push(n)}),r}function u(a,r){return b?void v.show():(v.empty().hide().siblings().remove(),k=h(a,r),k.length<1?void v.html(p.val()?t.add?"没有该数据，可添加":"没有该数据":"暂无数据").show():void e.each(k,function(a,n){var o=e("<div>");0===a&&o.addClass("hover").css({color:t.hoverColor,background:t.hoverBackground}),o.addClass("sinput-item").html(function(){var e=n[t.text];if(t.highlight&&r){var a=new RegExp(r,"g");e=e.replace(a,function(e){return"<b>"+e+"</b>"})}return e}).css({padding:t.padding}).appendTo(f),t.title&&o.attr("title",n[t.text]),t.ellipsis&&o.css({"white-space":"nowrap",overflow:"hidden","text-overflow":"ellipsis"})}))}function h(a,r){var n=[];return"string"!=typeof r||""===r?a:(e.each(a,function(e,a){a[t.text].indexOf(r)!==-1&&n.push(a)}),n)}var p=e(this).addClass(t.kls),f=e("<div>").addClass(t.kls),v=e("<div>"),g=p.attr("id");if(g&&t.unique&&(g="sinput-dropdown-"+g,e("#"+g).remove(),f.attr("id",g)),t.name&&p.attr("name",t.name),t.placeholder&&p.attr("placeholder",t.placeholder),t.maxLength){var x=parseInt(p.attr("maxlength"),10);x=x&&x>0?Math.min(x,t.maxLength):t.maxLength,p.attr("maxlength",x)}v.css({padding:t.padding,fontSize:t.fontSize}).hide().appendTo(f),f.css({maxHeight:t.height,fontSize:t.fontSize,border:t.border,cursor:"pointer",position:"absolute",display:"none",overflowX:"hidden",overflowY:"auto"}).appendTo("body"),t.zIndex&&f.css({zIndex:t.zIndex});var m=!1,y=!1,b=!1,w=[],k=[];t.ajax?t.init&&r("",function(){y=!0}):w=d(t.data),p.off(".sinput"),p.on("focus.sinput click.sinput",function(a){if("focus"===a.type&&(m=!0),m&&"click"===a.type||f.is(":visible"))return void(m=!1);var n=p.position(),o=p.outerHeight(),i=p.outerWidth();f.css({width:i,left:n.left,top:n.top+o,display:"block"});var s=e(this).val();y&&!s?(y=!1,u(w)):t.ajax&&!t.cache?r(s):u(w,s)}).on("input.sinput",function(){var a=e(this).val();return s(),f.show(),v.empty().hide().siblings().remove(),t.maxLength&&a.length>x?void v.html("输入文本已超出最大长度").show():void(t.ajax&&!t.cache?r(a,function(){i(a,t.onInput,t.forceTrigger)}):(u(w,a),i(a,t.onInput,t.forceTrigger)))}),e("body").on("mousedown.sinput",function(a){var r=e(a.target).closest("."+t.kls),n=f.is(":visible");n&&r.length<1&&o(!0)}),f.on("click",".sinput-item",function(){var a=e(this),r=a.text();p.val(r),i(r,t.callback),o()});var C=!1;f.on("mouseenter",".sinput-item",function(){return C?void(C=!1):void e(this).addClass("hover").css({color:t.hoverColor,background:t.hoverBackground}).siblings().removeClass("hover").css({color:"",background:""})}),p.on("keydown.sinput",function(e){var r=f.is(":hidden");switch(e.keyCode){case a.esc:case a.tab:r||o(!0);break;case a.up:t.preventKeyEvent&&e.preventDefault(),c(!0);break;case a.down:t.preventKeyEvent&&e.preventDefault(),r?(f.show(),u(w,p.val())):c();break;case a.enter:r?p.trigger("focus.sinput"):f.find(".hover").trigger("click")}})})}}(jQuery);